<div class="page-wrapper">
  <div class="team-banners" *ngIf="match">
    <div class="team-banner left-banner">
      <h1>{{ role === 'captain' ? getMyTeamName() : match.teams[0].name }}</h1>
    </div>
    <div class="team-banner right-banner">
      <h1>{{ role === 'captain' ? getEnemyTeamName() : match.teams[1].name }}</h1>
    </div>
  </div>

  <div class="state-body">
    <aside class="log-sidebar">
      <div class="log-header">
        <h3>Match Log</h3>
        <span class="live-indicator">LIVE</span>
      </div>
      <div class="log-content">
        <div *ngFor="let row of timelineRows" class="step-card" [class.current]="row.isCurrent"
          [class.done]="row.isDone">
          <!-- top -->
          <div class="step-strip">
            <div class="strip-left">
              <span class="step-num">{{ row.stepNum }}</span>
              <span class="step-team">{{ match?.teams?.[row.teamIndex]?.name }}</span>
            </div>

            <div class="step-right" [class.cyan]="row.teamIndex === 0" [class.red]="row.teamIndex === 1">
              {{ row.rightLabel }}
            </div>
          </div>

          <!-- map -->
          <div class="step-body" *ngIf="row.kind !== 'SIDE'"
            [style.background-image]="row.mapImgUrl ? ('url(' + row.mapImgUrl + ')') : 'none'">
            <div class="step-overlay"></div>

            <div class="step-body-content">
              <ng-container *ngIf="row.isDone; else pending">
                <div class="step-map">{{ row.mapName }}</div>
                <div class="step-sub" *ngIf="row.sideLabel">{{ row.sideLabel }}</div>
              </ng-container>

              <ng-template #pending>
                <div class="step-dots">•••</div>
              </ng-template>
            </div>
          </div>
        </div>
      </div>
    </aside>
    <main class="game-interface">

      <section *ngIf="match as m; else loadingOrError" class="match-layout">

        <section class="card main-stage">
          <header class="stage-header">
            <div class="stage-top">
              <div class="stage-left">
                <div class="stage-meta">
                  <div class="meta-item" (click)="copyMatchId()" title="Click to copy Match ID">
                    <span class="meta-label">Match ID</span>

                    <div class="match-id-wrapper">
                      <code class="meta-value">{{ matchId }}</code>

                      <span class="copy-feedback" [class.success]="matchIdCopied">
                        <span *ngIf="!matchIdCopied" class="icon">❐</span>
                        <span *ngIf="matchIdCopied" class="icon-check">✓</span>
                      </span>
                    </div>
                  </div>
                </div>
              </div>

            </div>

            <!-- Tells User the Phase -->
            <div class="stage-callout">
              <div class="callout-text">
                <ng-container *ngIf="isSidePhase; else mapPhaseHeader">
                  <ng-container *ngIf="isMyTurn; else enemySideTurn">
                    <h2 class="header-title my-turn">
                      CHOOSE SIDE ON <span class="val-white">{{ getCurrentStepMapName() }}</span>
                    </h2>
                  </ng-container>
                  <ng-template #enemySideTurn>
                    <h2 class="header-title enemy-text">
                      {{ role === 'spectator' ? 'SPECTATING:' : 'OPPONENT CHOOSING SIDE ON' }}
                      <span class="val-cyan-text">{{ getCurrentStepMapName() }}</span>
                    </h2>
                  </ng-template>
                </ng-container>

                <ng-template #mapPhaseHeader>
                  <ng-container *ngIf="isMyTurn; else enemyMapTurn">
                    <h2 class="header-title">
                      YOUR TEAM
                      <span [ngClass]="actionColorClass">
                        {{ isBanPhase ? 'BANS' : 'CHOOSES' }}
                      </span>
                      A MAP
                    </h2>
                  </ng-container>
                  <ng-template #enemyMapTurn>
                    <h2 class="header-title enemy-text">
                      {{ role === 'spectator' ? 'SPECTATING:' : 'WAITING FOR OTHER TEAM...' }}
                    </h2>
                  </ng-template>
                </ng-template>
              </div>

              <div class="stage-right">
                <span class="pill pill-turn" [class.friendly]="role === 'captain' && isMyTurn"
                  [class.enemy]="role === 'captain' && !isMyTurn">
                  {{ getTurnDisplay() }}
                </span>
              </div>
            </div>
          </header>


          <ng-container *ngIf="isSidePhase; else mapGridContent">
            <div class="side-selection-container">
              <button class="side-btn attack" (click)="onSideClick(0)" [disabled]="!isMyTurn">
                <div class="side-icon"><img src="public/sideimgs/attack-icon.png" alt="Attack" /></div>
                <span class="side-label">ATTACK</span>
              </button>
              <div class="vs-divider">OR</div>
              <button class="side-btn defense" (click)="onSideClick(1)" [disabled]="!isMyTurn">
                <div class="side-icon"><img src="public/sideimgs/defense-icon.png" alt="Defense" /></div>
                <span class="side-label">DEFENSE</span>
              </button>
            </div>
          </ng-container>

          <ng-template #mapGridContent>
            <div class="maps-grid" [class.inactive-turn]="isInteractionDisabled()">
              <button *ngFor="let map of m.availableMaps; trackBy: trackByMapId" class="map-btn" type="button"
                [disabled]="!isMyTurn" [class.banned]="isMapBanned(map)" [class.picked]="isMapPicked(map)"
                [class.decider]="isDecider(map)" (click)="onMapClick(map)">
                <div class="map-media-wrapper">
                  <video #videoRef class="map-video" *ngIf="map.previewUrl" [src]="map.previewUrl" playsinline loop
                    muted preload="metadata" controlslist="nodownload noplaybackrate noremoteplayback"
                    (mouseenter)="onMapHoverEnter(videoRef)" (mouseleave)="onMapHoverLeave(videoRef)"></video>

                  <div class="map-static-img" *ngIf="map.mapImgUrl"
                    [style.background-image]="'url(' + map.mapImgUrl + ')'"></div>

                  <div class="map-overlay">
                    <div class="map-name">{{ map.name }}</div>
                    <div class="map-status-pill" [class.decider]="isDecider(map)"
                      [class.banned]="!isDecider(map) && isMapBanned(map)"
                      [class.picked]="!isDecider(map) && isMapPicked(map)">

                      {{ (isMapBanned(map) ? 'BANNED' : (isMapPicked(map) ? 'PICKED' : 'DECIDER')) }}

                    </div>
                  </div>
                </div>
              </button>
            </div>
          </ng-template>
        </section>

        <div *ngIf="loading" class="loading">Processing...</div>
        <div *ngIf="errorMessage" class="error">{{ errorMessage }}</div>
      </section>

      <ng-template #loadingOrError>
        <section class="card loading-card">
          <h2>Connecting...</h2>
          <p *ngIf="errorMessage" class="error">{{ errorMessage }}</p>
        </section>
      </ng-template>
    </main>
  </div>
</div>
<div class="transition-overlay" *ngIf="overlayVisible" [ngClass]="overlayClass" [class.closing]="isOverlayClosing">
  <div class="overlay-content">
    <h1 class="overlay-title">{{ overlayTitle }}</h1>
    <h2 class="overlay-subtitle">{{ overlaySubtitle }}</h2>
  </div>
</div>